# Questionnaire CMS API — Comprehensive Overview

This document summarizes the public and admin APIs exposed by the application, including authentication, conventions (pagination, filtering), the standard response envelope, and each resource group with paths, parameters, and example requests/responses.

> OpenAPI/Swagger: A machine-readable spec is generated by RSwag at `swagger/v1/swagger.yaml`. This guide complements Swagger with human-friendly structure and examples.

## Base URL and Versioning
- Versioned prefix: `/api/v1`
- Example base URL (local): `http://localhost:3000/api/v1`

## Authentication & Security
- Scheme: Bearer token (HTTP Authorization header)
- Header: `Authorization: Bearer <token>`
- Obtain/Manage tokens via Auth endpoints:
  - `POST /api/v1/auth/login` — body `{ email, password }` → returns token
  - `DELETE /api/v1/auth/logout` — revoke current session token
  - `DELETE /api/v1/auth/logout_all` — revoke all tokens for user
  - `POST /api/v1/auth/refresh` — issue a fresh token
  - `GET /api/v1/auth/me` — current user info

### Example (login)
```bash
curl -X POST http://localhost:3000/api/v1/auth/login \
  -H 'Content-Type: application/json' \
  -d '{"email":"admin@example.com","password":"secret"}'
```

## Standard Response Envelope
Every JSON response conforms to a consistent envelope:
```json
{
  "status": "ok" | "error" | "redirect",
  "data": { ... },
  "errors": [ { "error_code": "...", "message": "...", "details": { ... } } ],
  "notes": ["human-readable notes"]
}
```

- 200 OK: Successful operations.
- 401 Unauthorized: Missing/invalid/expired token.
- 403 Forbidden: Authenticated but not allowed.
- 404 Not Found: Resource doesn’t exist for caller.
- 422 Unprocessable Entity: Validation errors (with `errors` filled).

## Conventions
- IDs: Numeric integer IDs in paths.
- Pagination (list endpoints): `?page=1&per_page=25` (unless noted otherwise).
- Filtering/Sorting: Common params include `active`, `is_required`, `search`, `sort_by`, `sort_order`.
- Timestamps: ISO 8601 strings.

---

## Admin API
All Admin endpoints require an admin user. Paths are under `/api/v1/admin`.

### Assessments
- `GET /admin/assessments` — list
- `POST /admin/assessments` — create
- `GET /admin/assessments/{assessment_id}` — show
- `PATCH /admin/assessments/{assessment_id}` — update
- `DELETE /admin/assessments/{assessment_id}` — destroy

Sections and Questions (nested under an assessment):
- `POST /admin/assessments/{assessment_id}/sections` — create section
- `PATCH /admin/assessments/{assessment_id}/sections/{id}` — update section
- `DELETE /admin/assessments/{assessment_id}/sections/{id}` — delete section
- `POST /admin/assessments/{assessment_id}/sections/{section_id}/questions` — create question
- `PATCH /admin/assessments/{assessment_id}/sections/{section_id}/questions/{id}` — update question
- `DELETE /admin/assessments/{assessment_id}/sections/{section_id}/questions/{id}` — delete question

Question Options (nested under a question):
- `GET/POST/PATCH/DELETE /admin/questions/{question_id}/options` — manage options (plus `POST /reorder`)

### Marking Schemes
`/admin/assessments/{assessment_id}/marking-schemes`
- `GET` — list schemes for an assessment
- `POST` — create scheme
- `GET /{id}` — show
- `PATCH /{id}` — update
- `DELETE /{id}` — destroy
- `POST /{id}/activate` — set this as the active scheme
- `POST /{id}/clone` — clone scheme

Response JSON includes numeric fields as numbers (e.g., `total_possible_score`), settings (passing score, grade boundaries, feedback templates), and assessment linkage.

### Marking Rules
`/admin/assessments/{assessment_id}/marking-schemes/{marking_scheme_id}/rules`
- `GET` — list rules
- `POST` — create rule (body varies by `rule_type` and question type)
- `GET /{id}` — show rule
- `PATCH /{id}` — update rule
- `DELETE /{id}` — delete rule
- `POST /bulk_create` — create reasonable defaults for all questions missing rules
- `GET /rule_types` — list available rule types for a question
- `GET /criteria_fields` — return criteria schema for a given `rule_type`

See `docs/MARKING_SCHEME_AND_RULES.md` for a detailed guide on all rule types and parameters.

### Countries (Admin)
- `GET /admin/countries` — list
- `POST /admin/countries` — create
- `PATCH /admin/countries/{id}` — update
- `DELETE /admin/countries/{id}` — destroy
- `PATCH /admin/countries/{id}/activate` — activate
- `PATCH /admin/countries/{id}/deactivate` — deactivate
- `GET /admin/countries/{id}/statistics` — usage stats

### Users (Admin)
- `GET/POST /admin/users`
- `GET/PATCH/DELETE /admin/users/{id}`
- `PATCH /admin/users/{id}/make_admin` — grant admin
- `PATCH /admin/users/{id}/remove_admin` — revoke admin
- `POST /admin/users/invite` — invite a user

---

## Business API
Business endpoints are for non-admin users taking and managing assessments. Paths are under `/api/v1/business`.

### Read-only Assessments
- `GET /assessments` — list available assessments
- `GET /assessments/{assessment_id}` — show assessment

### Response Sessions (take an assessment)
`/business/assessments/{assessment_id}/response-sessions`
- `GET` — list my sessions for the assessment
- `POST` — create a new session

`/business/assessments/{assessment_id}/response-sessions/{id}`
- `GET` — show session
- `PATCH` — update session (e.g., respondent_name)
- `PATCH /start` — transition `draft` → `started`; returns meta with next links

Section navigation and responses:
- `GET /business/assessments/{assessment_id}/response-sessions/{id}/sections/{section_id}` —
  Fetch a section and the questions the user can answer now. Response structure:
  ```json
  {
    "status": "ok",
    "data": {
      "section": {
        "id": 10,
        "name": "Introduction",
        "order": 1,
        "questions": [ { /* question with options if applicable */ } ]
      }
    }
  }
  ```
- `GET /business/assessments/{assessment_id}/response-sessions/{id}/section_responses/{section_id}` —
  Fetch existing saved responses for the section’s visible questions.
- `PATCH /business/assessments/{assessment_id}/response-sessions/{id}/sections/{section_id}/submit` —
  Submit responses for the current section. Body is an array of response objects (see schemas below). Returns meta with next/prev links.

Body (request) for section submission — example (varies by question type):
```json
[
  { "question_id": 100, "selected_option_ids": [1,2] },
  { "question_id": 101, "number": 4 },
  { "question_id": 102, "text": "My answer" },
  { "question_id": 103, "date": "2025-01-01" }
]
```

Typical meta returned by `start` and `submit` responses:
```json
{
  "meta": {
    "first_section_id": 10,               // only on start
    "next_section_id": 11,                // on submit
    "previous_section_id": 9,             // on submit
    "links": {
      "show_section": "/.../sections/10",                     // GET section + questions
      "show_next_section": "/.../sections/11",                 // GET
      "show_previous_section": "/.../sections/9",              // GET
      "submit_section": "/.../sections/10/submit"              // PATCH
    }
  }
}
```

### Response Value Conventions by Question Type
- MultipleChoice/Radio/BooleanType: `selected_option_ids: [int]`
- RangeType: `{ number: <numeric> }`
- DateType: `{ date: "YYYY-MM-DD" }` (or variant)
- RichText: `{ text: "..." }`
- FileUpload: `{ filename, size, content_type, ... }`

---

## Schemas (selected)
See Swagger components for formal JSON Schemas:
- `ApiResponse` — global envelope
- `Error` — error object
- `Assessment`, `AssessmentSection`, `AssessmentQuestion`, `AssessmentQuestionOption`
- `AssessmentResponseSession`
- `AssessmentQuestionResponse`
- `MarkingScheme`, `MarkingRule`
- Business meta: `BusinessStartMeta`, `BusinessSubmitMeta`
- Business request: `BusinessSectionSubmitRequest`

---

## Error Handling
- Validation errors (422) include a detailed `errors` array (with `error_code`, `message`, and `details`).
- Not found (404), forbidden (403), and auth errors (401) follow the same envelope with `status: "error"`.

---

## Examples

### Start a response session
```bash
curl -X PATCH \
  "http://localhost:3000/api/v1/business/assessments/1/response-sessions/42/start" \
  -H "Authorization: Bearer $TOKEN"
```

### Fetch a section and questions
```bash
curl -X GET \
  "http://localhost:3000/api/v1/business/assessments/1/response-sessions/42/sections/10" \
  -H "Authorization: Bearer $TOKEN"
```

### Submit responses for a section
```bash
curl -X PATCH \
  "http://localhost:3000/api/v1/business/assessments/1/response-sessions/42/sections/10/submit" \
  -H "Authorization: Bearer $TOKEN" -H 'Content-Type: application/json' \
  -d '[{"question_id":100,"text":"My answer"}]'
```

---

## Notes & Best Practices
- Use the Business endpoints from the client application; Admin endpoints are for back-office tools.
- Respect visibility and completion rules: the API only returns questions the user can answer now and blocks access to future sections until prerequisites are satisfied.
- For marking behavior and rule configuration, consult `docs/MARKING_SCHEME_AND_RULES.md`.
