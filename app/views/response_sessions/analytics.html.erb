<div class="bg-white shadow rounded-lg">
  <div class="px-6 py-4 border-b border-gray-200">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-bold text-gray-900">Response Analytics</h1>
        <p class="text-sm text-gray-600">Performance metrics and insights for <%= @assessment.title %></p>
      </div>
      <div class="flex space-x-3">
        <%= link_to "Back to Sessions", assessment_response_sessions_path(@assessment),
            class: "bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded" %>
        <%= link_to "Export Data", export_assessment_response_sessions_path(@assessment, format: :csv),
            class: "bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded" %>
      </div>
    </div>
  </div>

  <!-- Overview Statistics -->
  <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
    <h2 class="text-lg font-medium text-gray-900 mb-4">Overview</h2>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
      <div class="bg-white p-6 rounded-lg shadow">
        <div class="text-3xl font-bold text-blue-600"><%= @stats[:total_sessions] %></div>
        <div class="text-sm text-gray-600 mt-1">Total Sessions</div>
        <div class="text-xs text-gray-500 mt-2">
          All response sessions created
        </div>
      </div>

      <div class="bg-white p-6 rounded-lg shadow">
        <div class="text-3xl font-bold text-green-600"><%= @stats[:completion_rate].round(1) %>%</div>
        <div class="text-sm text-gray-600 mt-1">Completion Rate</div>
        <div class="text-xs text-gray-500 mt-2">
          Sessions completed successfully
        </div>
      </div>

      <div class="bg-white p-6 rounded-lg shadow">
        <div class="text-3xl font-bold text-purple-600"><%= @stats[:average_score] %></div>
        <div class="text-sm text-gray-600 mt-1">Average Score</div>
        <div class="text-xs text-gray-500 mt-2">
          Mean score across all marked sessions
        </div>
      </div>

      <div class="bg-white p-6 rounded-lg shadow">
        <div class="text-3xl font-bold text-red-600"><%= @stats[:pass_rate] %>%</div>
        <div class="text-sm text-gray-600 mt-1">Pass Rate</div>
        <div class="text-xs text-gray-500 mt-2">
          Percentage of sessions that passed
        </div>
      </div>
    </div>
  </div>

  <!-- State Distribution -->
  <div class="px-6 py-4 border-b border-gray-200">
    <h2 class="text-lg font-medium text-gray-900 mb-4">Session States</h2>
    <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
      <% @stats[:by_state].each do |state, count| %>
        <div class="bg-gray-50 p-4 rounded-lg text-center">
          <div class="text-2xl font-bold text-gray-900"><%= count %></div>
          <div class="text-sm text-gray-600 mt-1">
            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium
                       <%= state_badge_class(state) %>">
              <%= state.humanize %>
            </span>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Score Distribution -->
  <div class="px-6 py-4 border-b border-gray-200">
    <h2 class="text-lg font-medium text-gray-900 mb-4">Score Distribution</h2>
    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
      <% @stats[:score_distribution].each do |range, count| %>
        <div class="bg-gray-50 p-4 rounded-lg text-center">
          <div class="text-2xl font-bold text-gray-900"><%= count %></div>
          <div class="text-sm text-gray-600 mt-1"><%= range %></div>
          <div class="text-xs text-gray-500 mt-1">
            <%= ((count.to_f / @stats[:total_sessions]) * 100).round(1) %>% of total
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Time Analytics -->
  <% if @stats[:time_analytics].present? %>
    <div class="px-6 py-4 border-b border-gray-200">
      <h2 class="text-lg font-medium text-gray-900 mb-4">Time Analytics</h2>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="bg-gray-50 p-4 rounded-lg text-center">
          <div class="text-xl font-bold text-gray-900"><%= @stats[:time_analytics][:average_duration] %> min</div>
          <div class="text-sm text-gray-600 mt-1">Average Duration</div>
        </div>
        <div class="bg-gray-50 p-4 rounded-lg text-center">
          <div class="text-xl font-bold text-gray-900"><%= @stats[:time_analytics][:median_duration] %> min</div>
          <div class="text-sm text-gray-600 mt-1">Median Duration</div>
        </div>
        <div class="bg-gray-50 p-4 rounded-lg text-center">
          <div class="text-xl font-bold text-gray-900"><%= @stats[:time_analytics][:min_duration] %> min</div>
          <div class="text-sm text-gray-600 mt-1">Fastest Completion</div>
        </div>
        <div class="bg-gray-50 p-4 rounded-lg text-center">
          <div class="text-xl font-bold text-gray-900"><%= @stats[:time_analytics][:max_duration] %> min</div>
          <div class="text-sm text-gray-600 mt-1">Slowest Completion</div>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Background Job Status -->
  <div class="px-6 py-4 border-b border-gray-200">
    <h2 class="text-lg font-medium text-gray-900 mb-4">Background Job Status</h2>
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="text-center">
          <div class="text-2xl font-bold text-blue-600" id="queued-jobs">-</div>
          <div class="text-sm text-blue-800">Queued Jobs</div>
        </div>
        <div class="text-center">
          <div class="text-2xl font-bold text-yellow-600" id="running-jobs">-</div>
          <div class="text-sm text-yellow-800">Running Jobs</div>
        </div>
        <div class="text-center">
          <div class="text-2xl font-bold text-red-600" id="failed-jobs">-</div>
          <div class="text-sm text-red-800">Failed Jobs</div>
        </div>
      </div>
      <div class="mt-4 text-center">
        <button id="refresh-jobs" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
          <i class="fas fa-sync-alt mr-2"></i>
          Refresh Job Status
        </button>
      </div>
    </div>
  </div>

  <!-- Recent Activity -->
  <div class="px-6 py-4">
    <h2 class="text-lg font-medium text-gray-900 mb-4">Recent Activity</h2>
    <div class="bg-gray-50 rounded-lg p-4">
      <div class="space-y-3">
        <% @sessions.recent.limit(10).each do |session| %>
          <div class="flex items-center justify-between py-2">
            <div class="flex items-center space-x-3">
              <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium
                         <%= state_badge_class(session.state) %>">
                <%= session.state.humanize %>
              </span>
              <span class="text-sm text-gray-900"><%= session.respondent_name %></span>
            </div>
            <div class="flex items-center space-x-4 text-sm text-gray-500">
              <% if session.marked? %>
                <span class="text-green-600 font-medium">
                  <%= session.total_score.to_i %>/<%= session.max_possible_score.to_i %>
                </span>
              <% end %>
              <span><%= time_ago_in_words(session.updated_at) %> ago</span>
              <%= link_to "View", assessment_response_session_path(@assessment, session),
                  class: "text-blue-600 hover:text-blue-900" %>
            </div>
          </div>
        <% end %>

        <% if @sessions.count == 0 %>
          <div class="text-center py-4 text-gray-500">
            No sessions found.
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Auto-refresh for job status -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const refreshBtn = document.getElementById('refresh-jobs');
  const queuedJobsEl = document.getElementById('queued-jobs');
  const runningJobsEl = document.getElementById('running-jobs');
  const failedJobsEl = document.getElementById('failed-jobs');

  function updateJobStatus() {
    fetch('/admin/job_status', {
      headers: {
        'Accept': 'application/json',
        'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
      }
    })
    .then(response => response.json())
    .then(data => {
      queuedJobsEl.textContent = data.queued || 0;
      runningJobsEl.textContent = data.running || 0;
      failedJobsEl.textContent = data.failed || 0;
    })
    .catch(error => {
      console.error('Error fetching job status:', error);
    });
  }

  if (refreshBtn) {
    refreshBtn.addEventListener('click', updateJobStatus);
  }

  // Auto-refresh every 30 seconds
  setInterval(updateJobStatus, 30000);

  // Initial load
  updateJobStatus();
});
</script>
