<div class="bg-white shadow rounded-lg">
  <div class="px-6 py-4 border-b border-gray-200">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-bold text-gray-900">Edit Marking Scheme</h1>
        <p class="text-sm text-gray-600">Editing "<%= @marking_scheme.name %>" for <%= @assessment.title %></p>
      </div>
      <div class="flex space-x-3">
        <%= link_to "Cancel", assessment_marking_scheme_path(@assessment, @marking_scheme),
            class: "bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded" %>
      </div>
    </div>
  </div>

  <div class="px-6 py-6">
    <%= form_with model: @marking_scheme, url: assessment_marking_scheme_path(@assessment, @marking_scheme), method: :patch, local: true, class: "space-y-6" do |form| %>
      <% if @marking_scheme.errors.any? %>
        <div class="bg-red-50 border border-red-200 rounded-md p-4">
          <div class="flex">
            <i class="fas fa-exclamation-circle text-red-400 mr-2 mt-0.5"></i>
            <div>
              <h3 class="text-sm font-medium text-red-800">
                <%= pluralize(@marking_scheme.errors.count, "error") %> prohibited this marking scheme from being saved:
              </h3>
              <ul class="mt-2 text-sm text-red-700 list-disc list-inside">
                <% @marking_scheme.errors.full_messages.each do |message| %>
                  <li><%= message %></li>
                <% end %>
              </ul>
            </div>
          </div>
        </div>
      <% end %>

      <!-- Basic Information -->
      <div class="bg-gray-50 rounded-lg p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Basic Information</h3>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <%= form.label :name, class: "block text-sm font-medium text-gray-700 mb-2" %>
            <%= form.text_field :name,
                class: "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" %>
          </div>

          <div>
            <%= form.label :total_possible_score, "Total Possible Score", class: "block text-sm font-medium text-gray-700 mb-2" %>
            <%= form.number_field :total_possible_score,
                step: 0.01,
                class: "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" %>
            <p class="mt-1 text-xs text-gray-500">This will be automatically calculated based on individual question rules</p>
          </div>
        </div>

        <div class="mt-4">
          <%= form.label :description, class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= form.text_area :description,
              rows: 3,
              class: "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" %>
        </div>

        <div class="mt-4">
          <label class="flex items-center">
            <%= form.check_box :is_active, class: "rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50" %>
            <span class="ml-2 text-sm text-gray-700">Set as active marking scheme</span>
          </label>
          <p class="mt-1 text-xs text-gray-500">Only one marking scheme can be active at a time</p>
        </div>
      </div>

      <!-- Grading Settings -->
      <div class="bg-gray-50 rounded-lg p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Grading Settings</h3>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <%= form.label "settings[passing_score]", "Passing Score (%)", class: "block text-sm font-medium text-gray-700 mb-2" %>
            <%= form.number_field "settings[passing_score]",
                value: @marking_scheme.settings&.dig('passing_score') || 60,
                min: 0, max: 100, step: 0.1,
                class: "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" %>
          </div>
        </div>

        <!-- Grade Boundaries -->
        <div class="mt-6">
          <h4 class="text-md font-medium text-gray-900 mb-3">Grade Boundaries</h4>
          <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
            <% ['A', 'B', 'C', 'D', 'F'].each do |grade| %>
              <div>
                <%= form.label "settings[grade_boundaries][#{grade}]", "Grade #{grade} (%)", class: "block text-sm font-medium text-gray-700 mb-2" %>
                <%= form.number_field "settings[grade_boundaries][#{grade}]",
                    value: @marking_scheme.settings&.dig('grade_boundaries', grade) || case grade
                      when 'A' then 90
                      when 'B' then 80
                      when 'C' then 70
                      when 'D' then 60
                      when 'F' then 0
                    end,
                    min: 0, max: 100, step: 1,
                    class: "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" %>
              </div>
            <% end %>
          </div>
        </div>

        <!-- Feedback Templates -->
        <div class="mt-6">
          <h4 class="text-md font-medium text-gray-900 mb-3">Feedback Templates</h4>
          <div class="space-y-4">
            <% ['A', 'B', 'C', 'D', 'F'].each do |grade| %>
              <div>
                <%= form.label "settings[feedback_templates][#{grade}]", "Grade #{grade} Feedback", class: "block text-sm font-medium text-gray-700 mb-2" %>
                <%= form.text_area "settings[feedback_templates][#{grade}]",
                    value: @marking_scheme.settings&.dig('feedback_templates', grade) || case grade
                      when 'A' then 'Excellent work, %{name}! You scored %{score}/%{max_score} (%{percentage}%)'
                      when 'B' then 'Good job, %{name}! You scored %{score}/%{max_score} (%{percentage}%)'
                      when 'C' then 'Well done, %{name}. You scored %{score}/%{max_score} (%{percentage}%)'
                      when 'D' then 'You passed, %{name}. You scored %{score}/%{max_score} (%{percentage}%)'
                      when 'F' then 'Please review the material, %{name}. You scored %{score}/%{max_score} (%{percentage}%)'
                    end,
                    rows: 2,
                    class: "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" %>
              </div>
            <% end %>
          </div>
          <div class="mt-2 text-xs text-gray-500">
            <p><strong>Available placeholders:</strong> %{name}, %{score}, %{max_score}, %{percentage}, %{grade}</p>
          </div>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="flex items-center justify-end space-x-4 pt-6 border-t border-gray-200">
        <%= link_to "Cancel", assessment_marking_scheme_path(@assessment, @marking_scheme),
            class: "px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" %>

        <%= form.submit "Update Marking Scheme",
            class: "px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" %>
      </div>
    <% end %>
  </div>
</div>
